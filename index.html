<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>入力テスト用ページ</title>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Noto Sans JP', 'Yu Gothic UI', Meiryo, sans-serif; }
    .wrapper { display: flex; flex-direction: column; height: 100%; width: 100%; }
    .textarea-wrap { flex: 1 1 auto; padding: 12px; box-sizing: border-box; }
    textarea { width: 100%; height: 100%; box-sizing: border-box; resize: none; font-size: 18px; line-height: 1.6; padding: 12px; }
    .footer { flex: 0 0 auto; padding: 12px; border-top: 1px solid #ddd; position: sticky; bottom: 0; background: #fff; }
    button { padding: 12px 16px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; background: #f6f6f6; }
    .row { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .row > * { margin-top:8px; }
    .hint { font-size: 12px; color: #666; margin-top: 8px; }
    .toast { position: fixed; right: 12px; bottom: 12px; background: #333; color: #fff; padding: 10px 12px; border-radius: 8px; opacity: 0.95; display: none; }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="textarea-wrap">
      <textarea id="editor" placeholder="ここにテキストを入れてください。"></textarea>
    </div>
    <div class="footer">
      <div class="row">
        <button id="copyBtn" type="button">クリップボードへコピー</button>
        <label style="display:flex;align-items:center;gap:8px;">
          <input id="copyOnBlur" type="checkbox" />
          フォーカス喪失時にコピー
        </label>
      </div>
      <div id="autoStatus" class="hint" aria-live="polite"></div>
      <div class="hint">
        ※ このモードでは、<b>ウィンドウ/タブのフォーカスを失ったタイミング</b>で、テキストエリアの内容をクリップボードにコピーします。<br />
        ※ 直前と同一の内容、または既にクリップボード先頭が同一のときはコピーをスキップし、履歴の重複を抑止します。<br />
        ※ クリップボードの参照は <code>clipboard-read</code> が <code>granted</code> のときのみ行います（ポップアップを誘発しません）。<br />
        ※ HTTPS または localhost でご利用ください。
      </div>
    </div>
  </div>
  <div id="toast" class="toast" role="status" aria-live="polite">コピーしました</div>
  <script>
    const ta = document.getElementById('editor');
    const copyBtn = document.getElementById('copyBtn');
    const copyOnBlur = document.getElementById('copyOnBlur');
    const autoStatus = document.getElementById('autoStatus');
    const toast = document.getElementById('toast');

    function setStatus(msg) { autoStatus.textContent = msg; }

    function showToast(msg) {
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 1500);
    }

    // === クリップボード（重複抑止 + 読み取りは granted の時のみ） ===
    const LAST_KEY = 'lastCopiedFromThisSite';
    let lastCopied = localStorage.getItem(LAST_KEY) ?? '';

    async function canReadClipboard() {
      try {
        if (navigator.permissions && navigator.permissions.query) {
          const st = await navigator.permissions.query({ name: 'clipboard-read' });
          return st && st.state === 'granted';
        }
      } catch {}
      return false;
    }

    async function readClipboardTopIfGranted() {
      if (!(await canReadClipboard())) return null;
      try {
        if (navigator.clipboard && window.isSecureContext && navigator.clipboard.readText) {
          return await navigator.clipboard.readText();
        }
      } catch {}
      return null;
    }

    async function writeClipboard(text) {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        return true;
      }
      try {
        // 非セキュア時のフォールバック（selection hack）
        const selStart = ta.selectionStart, selEnd = ta.selectionEnd;
        const prev = ta.value;
        ta.select();
        const ok = document.execCommand('copy');
        ta.value = prev;
        ta.selectionStart = selStart;
        ta.selectionEnd = selEnd;
        ta.focus();
        return ok;
      } catch { return false; }
    }

    async function copyWithDedupe(text) {
      const cur = text;
      // 1) クリップボード先頭が同一ならスキップ（許可がある場合のみ確認）
      const top = await readClipboardTopIfGranted(); // null の場合は未知
      if (top !== null && top === cur) {
        return { ok: true, skipped: true, reason: 'clipboard-top-same' };
      }
      // 2) 直前に本サイトがコピーした内容と同じならスキップ
      if (cur === lastCopied) {
        return { ok: true, skipped: true, reason: 'last-same' };
      }
      // 3) 通常コピー
      const ok = await writeClipboard(cur);
      if (ok) {
        lastCopied = cur;
        try { localStorage.setItem(LAST_KEY, lastCopied); } catch {}
      }
      return { ok, skipped: false };
    }

    // 手動コピー
    copyBtn.addEventListener('click', async () => {
      const text = ta.value;
      try {
        const res = await copyWithDedupe(text);
        if (res.ok) {
          showToast(res.skipped ? '重複のためスキップしました' : 'コピーしました');
        } else {
          alert('クリップボードへのコピーに失敗しました。HTTPS(またはlocalhost)での実行をご確認ください。');
        }
      } catch (err) {
        alert('クリップボードへのコピーでエラー:\n' + err);
      }
    });

    // === フォーカス喪失トリガ（タイマー不使用） ===
    function shouldCopyOnBlur() {
      return copyOnBlur.checked;
    }

    async function handleBlurLike() {
      if (!shouldCopyOnBlur()) return;
      const text = ta.value;
      if (!text || !text.trim()) { setStatus('空文字のためコピーしません'); return; }
      const res = await copyWithDedupe(text);
      if (res.ok) {
        if (res.skipped) {
          setStatus(res.reason === 'clipboard-top-same' ? 'スキップ：既に最新内容が先頭' : 'スキップ：前回と同一');
        } else {
          setStatus(`フォーカス喪失でコピーしました（${new Date().toLocaleTimeString()}）`);
        }
      } else {
        setStatus('コピー失敗');
      }
    }

    // ウィンドウのフォーカス喪失
    window.addEventListener('blur', handleBlurLike);

    // タブの可視性変化（バックグラウンドに回ったらコピー）
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) handleBlurLike();
    });

    // ページが隠れる/破棄される（pagehide は iOS/Safari などでも有効）
    window.addEventListener('pagehide', handleBlurLike);

    // 初期
    window.addEventListener('DOMContentLoaded', () => {
      ta.focus();
      setStatus('フォーカス喪失時コピー：停止中');
    });
    copyOnBlur.addEventListener('change', () => {
      setStatus(copyOnBlur.checked ? 'フォーカス喪失時コピー：稼働中' : 'フォーカス喪失時コピー：停止中');
    });
  </script>
</body>
</html>
