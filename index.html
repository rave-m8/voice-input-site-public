<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>入力テスト用ページ</title>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Noto Sans JP', 'Yu Gothic UI', Meiryo, sans-serif; }
    .wrapper { display: flex; flex-direction: column; height: 100%; width: 100%; }
    .textarea-wrap { flex: 1 1 auto; padding: 12px; box-sizing: border-box; }
    textarea { width: 100%; height: 100%; box-sizing: border-box; resize: none; font-size: 18px; line-height: 1.6; padding: 12px; }
    .footer { flex: 0 0 auto; padding: 12px; border-top: 1px solid #ddd; position: sticky; bottom: 0; background: #fff; }
    .row { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .row > * { margin-top:8px; }
    button { padding: 12px 16px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; background: #f6f6f6; }
    .hint { font-size: 12px; color: #666; margin-top: 8px; }
    .toast { position: fixed; right: 12px; bottom: 12px; background: #333; color: #fff; padding: 10px 12px; border-radius: 8px; opacity: 0.95; display: none; }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="textarea-wrap">
      <textarea id="editor" placeholder="ここにテキストを入れてください。"></textarea>
    </div>
    <div class="footer">
      <div class="row">
        <button id="copyBtn" type="button">クリップボードへコピー</button>
        <button id="copyAndCloseBtn" type="button">コピーして閉じる</button>
      </div>
      <div id="status" class="hint" aria-live="polite"></div>
      <div class="hint">
        選択範囲がある場合は <b>選択中の部分だけ</b>、ない場合は <b>全体</b> をコピーします。<br />
        クリップボード API は <b>HTTPS または localhost</b> で安定します。
      </div>
    </div>
  </div>
  <div id="toast" class="toast" role="status" aria-live="polite">コピーしました</div>
  <script>
    const ta = document.getElementById('editor');
    const copyBtn = document.getElementById('copyBtn');
    const copyAndCloseBtn = document.getElementById('copyAndCloseBtn');
    const statusEl = document.getElementById('status');
    const toast = document.getElementById('toast');

    function showToast(msg) {
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 1200);
    }
    function setStatus(msg) { statusEl.textContent = msg; }

    function getSelectedOrAllText() {
      const start = ta.selectionStart ?? 0;
      const end   = ta.selectionEnd ?? 0;
      if (start !== end) return ta.value.substring(start, end);
      return ta.value;
    }

    async function copyString(text) {
      // 1) クリップボード API（推奨）
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        return true;
      }
      // 2) フォールバック（execCommand）
      try {
        const start = ta.selectionStart ?? 0;
        const end   = ta.selectionEnd ?? 0;
        const hasSel = start !== end;

        if (hasSel) {
          // 選択中の内容をそのままコピー
          const ok = document.execCommand('copy');
          return ok;
        } else {
          // 一旦全選択→コピー→元に戻す
          const prevScrollTop  = ta.scrollTop;
          const prevSelectionStart = start;
          const prevSelectionEnd   = end;

          ta.select();
          const ok = document.execCommand('copy');

          // 元の状態に戻す
          ta.setSelectionRange(prevSelectionStart, prevSelectionEnd);
          ta.scrollTop = prevScrollTop;
          ta.focus();

          return ok;
        }
      } catch (e) {
        console.error('copy fallback failed:', e);
        return false;
      }
    }

    async function handleCopy() {
      const text = getSelectedOrAllText();
      if (!text) { setStatus('空文字のためコピーしません'); return false; }

      try {
        const ok = await copyString(text);
        if (ok) {
          showToast('コピーしました');
          setStatus(`コピーしました（${new Date().toLocaleTimeString()}）`);
        } else {
          setStatus('コピーに失敗しました。HTTPS(またはlocalhost)で実行してください。');
        }
        return ok;
      } catch (err) {
        console.error(err);
        setStatus('コピーでエラーが発生しました。詳細はコンソールをご確認ください。');
        return false;
      }
    }

    copyBtn.addEventListener('click', async () => {
      await handleCopy();
    });

    copyAndCloseBtn.addEventListener('click', async () => {
      const ok = await handleCopy();
      if (ok) {
        try { window.close(); } catch {}
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      ta.focus();
      setStatus('準備完了');
    });
  </script>
</body>
</html>
